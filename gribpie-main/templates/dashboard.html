{% extends "base.html" %}
{% block title %}–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è - GribPie{% endblock %}
{% block content %}
<h1>–ú–æ–∏ –ø—Ä–æ–µ–∫—Ç—ã</h1>

<div class="card-grid">
    <div class="project-card">
        <h3>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</h3>
        <form method="POST" action="{{ url_for('create_project') }}">
            <input type="text" name="name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞" required minlength="3">
            <button type="submit" class="button success">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
        </form>
    </div>
    
    <div class="project-card" style="background: var(--light);">
        <h3>–í—Å–µ –º–æ–∏ —Ñ–∞–π–ª—ã</h3>
        <p>–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ–º–∏ —Ñ–∞–π–ª–∞–º–∏ –∏–∑ –≤—Å–µ—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤</p>
        <a href="{{ url_for('all_files') }}" class="button primary" style="margin-top: 10px;">–û—Ç–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤</a>
    </div>
</div>

<div class="projects-section">
    <div class="project-section">
        <h2 class="project-section-title">–õ–∏—á–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</h2>
        {% if personal_projects %}
        <div class="project-list">
            {% for project in personal_projects %}
            <div class="project-card">
                <div class="project-header">
                    <span class="project-name">{{ project.name }}</span>
                    <span class="storage-info">
                        –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: {{ project.storage_used|format_size }} –∏–∑ {{ 262144000|format_size }}
                    </span>
                </div>
                
                <div class="upload-form">
                    <form method="POST" action="{{ url_for('upload_file', project_id=project.id) }}" enctype="multipart/form-data" onsubmit="return validateFileSize({{ project.storage_used }}, {{ 262144000 - project.storage_used }})">
                        <input type="file" name="file" id="file-{{ project.id }}" required onchange="checkFileSize(this, {{ 262144000 - project.storage_used }})">
                        <button type="submit" class="button primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
                    </form>
                </div>
                
                {% set files = project.files %}
                {% if files %}
                <div class="file-list">
                    <h4>–§–∞–π–ª—ã ({{ files|length }}):</h4>
                    {% for file in files %}
                    <div class="file-item">
                        <div class="file-details">
                            <div class="file-icon">
                                <i>üìÑ</i>
                            </div>
                            <div class="file-name">
                                {{ file.filename }}
                            </div>
                            <div class="file-size">
                                ({{ file.size|format_size }})
                            </div>
                        </div>
                        <div class="file-actions">
                            <a href="{{ url_for('download_file', file_id=file.id) }}" class="button secondary">
                                –°–∫–∞—á–∞—Ç—å
                            </a>
                            <a href="{{ url_for('delete_file', file_id=file.id) }}" class="button danger" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª?')">
                                –£–¥–∞–ª–∏—Ç—å
                            </a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="share-section">
                    <h4>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è –ø—Ä–æ–µ–∫—Ç–æ–º</h4>
                    <div class="share-link">
                        <input type="text" id="share-link-{{ project.id }}" readonly placeholder="–°—Å—ã–ª–∫–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞">
                        <button class="button secondary" onclick="getShareLink({{ project.id }})">–ü–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É</button>
                        <button class="button success" onclick="generateQR({{ project.id }})">–°–¥–µ–ª–∞—Ç—å QR</button>
                        <button class="button danger" onclick="deleteProject({{ project.id }}, '{{ project.name }}')" style="margin-top: 10px;">
                            –£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ª–∏—á–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π!</p>
        {% endif %}
    </div>
    
    {% if shared_projects %}
    <div class="project-section">
        <h2 class="project-section-title">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã</h2>
        <div class="project-list">
            {% for item in shared_projects %}
            <div class="project-card">
                <div class="project-header">
                    <span class="project-name">{{ item.project.name }}</span>
                    <span class="project-access">–î–æ—Å—Ç—É–ø: {{ item.access_level }}</span>
                </div>
                
                <div class="upload-form">
                    {% if item.access_level == 'edit' %}
                    <form method="POST" action="{{ url_for('upload_file', project_id=item.project.id) }}" enctype="multipart/form-data" onsubmit="return validateFileSize({{ item.project.storage_used }}, {{ 262144000 - item.project.storage_used }})">
                        <input type="file" name="file" id="file-{{ item.project.id }}" required onchange="checkFileSize(this, {{ 262144000 - item.project.storage_used }})">
                        <button type="submit" class="button primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
                    </form>
                    {% else %}
                    <p>–í—ã –º–æ–∂–µ—Ç–µ —Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Ñ–∞–π–ª—ã –≤ —ç—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–µ</p>
                    {% endif %}
                </div>
                
                {% set files = item.project.files %}
                {% if files %}
                <div class="file-list">
                    <h4>–§–∞–π–ª—ã ({{ files|length }}):</h4>
                    {% for file in files %}
                    <div class="file-item">
                        <div class="file-details">
                            <div class="file-icon">
                                <i>üìÑ</i>
                            </div>
                            <div class="file-name">
                                {{ file.filename }}
                            </div>
                            <div class="file-size">
                                ({{ file.size|format_size }})
                            </div>
                        </div>
                        <div class="file-actions">
                            <a href="{{ url_for('download_file', file_id=file.id) }}" class="button secondary">
                                –°–∫–∞—á–∞—Ç—å
                            </a>
                            {% if item.access_level == 'edit' %}
                            <a href="{{ url_for('delete_file', file_id=file.id) }}" class="button danger" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª?')">
                                –£–¥–∞–ª–∏—Ç—å
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<div id="qr-modal" class="qr-modal" style="display: none;">
    <div class="qr-modal-content">
        <h3>QR-–∫–æ–¥ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–æ–µ–∫—Ç—É</h3>
        <div id="qr-container" class="qr-container"></div>
        <div class="qr-url-container">
            <input type="text" id="qr-url" class="qr-url" readonly>
        </div>
        <div class="qr-actions">
            <button class="button secondary" onclick="copyQRToClipboard()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
            <button class="button primary" onclick="closeQRModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        <p class="qr-instruction">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∫–∞–º–µ—Ä–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞</p>
    </div>
</div>

<div id="error-modal" class="error-modal" style="display: none;">
    <div class="error-modal-content">
        <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞</h3>
        <p id="error-message">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞</p>
        <button class="button primary" onclick="closeErrorModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<script>
function getShareLink(projectId) {
    fetch(`/get_share_link/${projectId}`)
        .then(response => response.json())
        .then(data => {
            if (data.url) {
                document.getElementById(`share-link-${projectId}`).value = data.url;
                document.getElementById(`share-link-${projectId}`).select();
                document.execCommand('copy');
                alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
            } else {
                alert('–û—à–∏–±–∫–∞: ' + data.error);
            }
        })
        .catch(error => {
            alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Å—ã–ª–∫–∏');
        });
}

function generateQR(projectId) {
    fetch(`/get_share_link/${projectId}`)
        .then(response => response.json())
        .then(data => {
            if (data.token) {
                fetch(`/generate_qr/${data.token}`)
                    .then(response => response.json())
                    .then(qrData => {
                        document.getElementById('qr-url').value = qrData.url;
                        document.getElementById('qr-container').innerHTML = `<img src="${qrData.qr_data}" alt="QR Code">`;
                        document.getElementById('qr-modal').style.display = 'block';
                    });
            }
        });
}

function closeQRModal() {
    document.getElementById('qr-modal').style.display = 'none';
}

function copyQRToClipboard() {
    const url = document.getElementById('qr-url').value;
    navigator.clipboard.writeText(url).then(() => {
        alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
    });
}

function deleteProject(projectId, projectName) {
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç "${projectName}"? –í—Å–µ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!`)) {
        window.location.href = `/delete_project/${projectId}`;
    }
}

function checkFileSize(input, remainingSpace) {
    const file = input.files[0];
    const maxSize = 262144000;
    
    if (file.size > remainingSpace) {
        showError(`–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –û—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ ${formatSize(remainingSpace)} —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –≤ –ø—Ä–æ–µ–∫—Ç–µ.`);
        input.value = '';
        return false;
    }
    
    if (file.size > maxSize) {
        showError(`–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 250 –ú–ë`);
        input.value = '';
        return false;
    }
    
    return true;
}

function validateFileSize(usedSpace, remainingSpace) {
    const fileInput = document.querySelector(`input[name="file"]`);
    if (fileInput && fileInput.files.length > 0) {
        const file = fileInput.files[0];
        if (file.size > remainingSpace) {
            showError(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ. –û—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ ${formatSize(remainingSpace)}.`);
            return false;
        }
    }
    return true;
}

function showError(message) {
    document.getElementById('error-message').textContent = message;
    document.getElementById('error-modal').style.display = 'flex';
}

function closeErrorModal() {
    document.getElementById('error-modal').style.display = 'none';
}

function formatSize(bytes) {
    if (bytes >= 1024 * 1024 * 1024) {
        return (bytes / (1024 * 1024 * 1024)).toFixed(2) + ' –ì–ë';
    } else if (bytes >= 1024 * 1024) {
        return (bytes / (1024 * 1024)).toFixed(2) + ' –ú–ë';
    } else if (bytes >= 1024) {
        return (bytes / 1024).toFixed(2) + ' –ö–ë';
    } else {
        return bytes + ' –ë';
    }
}
</script>
{% endblock %}
