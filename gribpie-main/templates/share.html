{% extends "base.html" %}
{% block title %}–û–±—â–∏–π –¥–æ—Å—Ç—É–ø - GribPie{% endblock %}
{% block content %}
<h1>–û–±—â–∏–π –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–æ–µ–∫—Ç—É</h1>
<h2>{{ project.name }}</h2>

<div style="display: grid; grid-template-columns: 1fr; gap: 20px; margin: 30px 0;">
    <div>
        {% if files %}
        <div class="file-list">
            <h3>–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã ({{ files|length }}):</h3>
            {% for file in files %}
            <div class="file-item">
                <div class="file-details">
                    <div class="file-icon">
                        <i>üìÑ</i>
                    </div>
                    <div class="file-name">
                        {{ file.filename }}
                    </div>
                    <div class="file-size">
                        ({{ "%.2f"|format(file.size / 1024 / 1024) }} –ú–ë)
                    </div>
                </div>
                <div class="file-actions">
                    <a href="{{ url_for('download_file', file_id=file.id) }}" class="button secondary">
                        –°–∫–∞—á–∞—Ç—å
                    </a>
                    {% if not current_user.is_authenticated %}
                    <a href="{{ url_for('login') }}" class="button primary">
                        –í–æ–π—Ç–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                    </a>
                    {% else %}
                    <a href="{{ url_for('delete_file', file_id=file.id) }}" class="button danger" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª?')">
                        –£–¥–∞–ª–∏—Ç—å
                    </a>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p>–í —ç—Ç–æ–º –ø—Ä–æ–µ–∫—Ç–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ñ–∞–π–ª–æ–≤.</p>
        {% endif %}
        
        {% if current_user.is_authenticated %}
        <div class="upload-form">
            <form method="POST" action="{{ url_for('upload_file', project_id=project.id) }}" enctype="multipart/form-data">
                <input type="file" name="file" required>
                <button type="submit" class="button primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
            </form>
        </div>
        {% else %}
        <p><a href="{{ url_for('login') }}" class="button primary">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</a> –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤</p>
        {% endif %}
    </div>
    
    <div style="background: white; padding: 30px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
        <h3>–ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø</h3>
        <p>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏</p>
        <div id="qr-container" class="qr-container" style="margin: 25px auto;"></div>
        <input type="text" id="share-url" value="{{ url_for('share', token=token, _external=True) }}" readonly style="width: 100%; padding: 12px; margin: 15px 0; font-size: 14px; border: 2px solid #e1e5eb; border-radius: 8px;">
        <button class="button secondary" onclick="copyShareLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
    </div>
</div>

<h3>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ –ø—Ä–æ–µ–∫—Ç—É</h3>
<div class="users-list">
    {% for user in users_with_access %}
    <div class="user-item">
        <div class="user-info">
            <div class="user-icon">
                {{ user.username[0]|upper }}
            </div>
            <div class="user-name">
                {{ user.username }}
            </div>
            <div class="user-access">
                –î–æ—Å—Ç—É–ø: 
                <span class="access-indicator {{ user.access_level }}">{{ user.access_level }}</span>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% if current_user.is_authenticated %}
    <p><a href="{{ url_for('dashboard') }}" class="button primary">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</a></p>
{% else %}
    <p><a href="{{ url_for('login') }}" class="button primary">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</a> –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞</p>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script>
    new QRCode(document.getElementById("qr-container"), {
        text: "{{ url_for('share', token=token, _external=True) }}",
        width: 200,
        height: 200,
        correctLevel: QRCode.CorrectLevel.L
    });

    function copyShareLink() {
        const url = document.getElementById('share-url').value;
        navigator.clipboard.writeText(url).then(() => {
            alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
        });
    }
</script>
{% endblock %}
